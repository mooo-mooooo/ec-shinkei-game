
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ECあるある神経衰弱</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #DC143C;
            font-size: clamp(24px, 5vw, 36px);
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        #score, #timer, #attemptsLeft, #playerCount { /* #attemptsLeft に変更 */
            font-size: clamp(18px, 4vw, 24px);
            font-weight: bold;
            color: #DC143C;
            background: #FFE4E1;
            padding: 10px 20px;
            border-radius: 30px;
            border: 2px solid #DC143C;
            flex-grow: 1; /* 要素が均等に広がるように */
            text-align: center; /* テキストを中央寄せ */
        }

        #timer {
            color: #8B0000;
            border: 2px solid #8B0000;
        }

        #attemptsLeft { /* 残り失敗可能数用のスタイル */
            color: #FF4500; /* オレンジレッド */
            border: 2px solid #FF4500;
        }
        
        #playerCount { /* 挑戦者数用のスタイル */
            color: #008080; /* ティール */
            border: 2px solid #008080;
        }


        #gameBoard {
            display: grid;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }

        /* レスポンシブグリッドを12枚用に調整 (3x4または4x3) */
        @media (max-width: 480px) {
            #gameBoard {
                grid-template-columns: repeat(3, 1fr); /* スマートフォンでは3列 */
            }
            .game-container {
                padding: 20px;
            }
            .game-info {
                flex-direction: column; /* 縦並びにする */
                align-items: stretch; /* 幅いっぱいに広げる */
            }
            #score, #timer, #attemptsLeft, #playerCount {
                width: 100%; /* 幅いっぱいに */
            }
        }

         @media (min-width: 481px) and (max-width: 768px) {
            #gameBoard {
                grid-template-columns: repeat(3, 1fr); /* タブレットでは3列 (縦4枚、横3枚) */
            }
        }
        @media (min-width: 769px) {
            #gameBoard {
                grid-template-columns: repeat(4, 1fr); /* デスクトップでは4列 (縦3枚、横4枚) */
            }
        }

        .card {
            aspect-ratio: 3/2;
            background: url('card_back.png') no-repeat center center; /* 'card_back.png'をあなたの画像ファイル名に置き換えてください */
            background-size: cover; /* カード全体に画像をフィットさせる */
            color: transparent; /* 文字を透明にする (表面用) */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            cursor: pointer;
            font-size: clamp(12px, 2.5vw, 16px);
            text-align: center;
            padding: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3);
            min-height: 80px;
            font-weight: bold;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            transform: rotate(45deg);
            transition: all 0.5s ease;
            opacity: 0;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:active {
            transform: scale(0.95);
        }

        .card.flipped {
            background: white; /* めくられたカードの背景色 */
            color: #DC143C; /* めくられたときに文字色を赤にする */
            border: 3px solid #DC143C;
            animation: flipAnimation 0.3s ease;
            font-weight: bold;
        }

        @keyframes flipAnimation {
            0% {
                transform: scale(1, 1);
            }
            50% {
                transform: scale(0.1, 1);
            }
            100% {
                transform: scale(1, 1);
            }
        }

        .card.matched {
            background: linear-gradient(135deg, #68d391 0%, #48bb78 100%);
            color: white;
            border: none;
            animation: matchPulse 0.6s ease;
            box-shadow: 0 0 20px rgba(72, 187, 120, 0.5);
        }

        @keyframes matchPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px; /* ボタン間のスペース */
            flex-wrap: wrap; /* 小さい画面で折り返す */
        }

        button {
            padding: 15px 30px;
            font-size: clamp(16px, 3vw, 18px);
            font-weight: bold;
            background: linear-gradient(135deg, #DC143C 0%, #8B0000 100%);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(220, 20, 60, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 20, 60, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto; /* 追加 */
            padding: 20px; /* 追加 */
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            max-height: 90vh; /* 追加 */
            overflow-y: auto; /* 追加 */
            animation: modalSlideIn 0.3s ease;
            border: 3px solid #DC143C;
            margin: auto; /* 追加 */
        }
        
        /* スマートフォン用の調整 */
        @media (max-width: 480px) {
            .modal-content {
                padding: 20px;
                max-height: 85vh;
                margin: 10px;
            }
            
            .ranking-section {
                max-height: 200px;
                overflow-y: auto;
            }
        }
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal h2 {
            color: #DC143C;
            font-size: clamp(24px, 5vw, 36px);
            margin-bottom: 20px;
        }
        .modal p {
            font-size: clamp(16px, 3vw, 20px);
            margin-bottom: 10px; /* 調整 */
            color: #666;
        }
        /* タッチデバイス用の調整 */
        @media (hover: none) {
            .card:hover::before {
                opacity: 0;
            }
        }
        #playerName {
            padding: 10px 20px;
            font-size: 16px;
            border: 2px solid #DC143C;
            border-radius: 20px;
            margin: 10px;
            width: 200px;
            max-width: 80%;
        }
        
        .ranking-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        
        .ranking-section h3 {
            color: #DC143C;
            font-size: clamp(18px, 4vw, 24px);
            margin-bottom: 15px;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f8f8;
            border-radius: 10px;
            font-size: clamp(14px, 3vw, 16px);
        }
        
        .ranking-item:nth-child(1) {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            font-weight: bold;
        }
        
        .ranking-item:nth-child(2) {
            background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%);
            color: white;
        }
        
        .ranking-item:nth-child(3) {
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
            color: white;
        }
        
        .rank {
            font-weight: bold;
            min-width: 40px;
        }
        
        .name {
            flex: 1;
            text-align: left;
            margin: 0 10px;
            word-break: break-all; /* 長い名前がはみ出さないように */
        }
        
        .time {
            font-weight: bold;
            color: #DC143C;
        }
        
        .ranking-item:nth-child(1) .time,
        .ranking-item:nth-child(2) .time,
        .ranking-item:nth-child(3) .time {
            color: white;
        }
        
        #rankingList2 {
            max-height: 400px;
            overflow-y: auto;
        }
        /* ランキングセクションの高さ制限 */
        #rankingList {
            max-height: 250px;
            overflow-y: auto;
            padding: 10px;
        }
        
        /* スクロールバーのスタイリング（オプション） */
        .modal-content::-webkit-scrollbar,
        #rankingList::-webkit-scrollbar,
        #rankingList2::-webkit-scrollbar { /* #rankingList2 も追加 */
            width: 8px;
        }
        
        .modal-content::-webkit-scrollbar-track,
        #rankingList::-webkit-scrollbar-track,
        #rankingList2::-webkit-scrollbar-track { /* #rankingList2 も追加 */
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .modal-content::-webkit-scrollbar-thumb,
        #rankingList::-webkit-scrollbar-thumb,
        #rankingList2::-webkit-scrollbar-thumb { /* #rankingList2 も追加 */
            background: #DC143C;
            border-radius: 10px;
        }
        
        .modal-content::-webkit-scrollbar-thumb:hover,
        #rankingList::-webkit-scrollbar-thumb:hover,
        #rankingList2::-webkit-scrollbar-thumb:hover { /* #rankingList2 も追加 */
            background: #8B0000;
        }

        .admin-buttons button { /* 管理者ボタンのスタイル調整 */
            font-size: clamp(14px, 3vw, 16px);
            padding: 10px 15px;
            margin: 5px;
        }

        /* 難易度選択モーダル用スタイル */
        .difficulty-buttons button {
            margin: 10px;
            padding: 15px 30px;
            font-size: clamp(18px, 4vw, 22px);
            background: #4CAF50;
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        .difficulty-buttons button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        /* 新しいボタンの背景色 */
        .difficulty-buttons button.interest-button {
            background: #2196F3; /* 青色 */
        }
        .difficulty-buttons button.interest-button:hover {
            background: #1976D2;
        }

        /* カードの裏面と表面のテキスト表示調整 */
        .card .card-back-content { /* 裏面（あるある）表示用 */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: black; /* 裏面の文字色を黒に */
            z-index: 2; 
            display: flex; 
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 5px; 
            box-sizing: border-box;
        }
        .card.flipped .card-back-content {
            display: none; /* めくれたら裏面は非表示 */
        }
        .card .card-front-content { /* 表面（解決策）表示用 */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: transparent; /* 最初は透明 */
            z-index: 3; 
            display: flex; 
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        .card.flipped .card-front-content {
            color: #DC143C; /* めくれたら色を出す */
        }
        .card.matched .card-front-content {
            color: white; /* マッチしたら白に */
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1><center>🛍️ ECあるある 解決神経衰弱 🛍️<br>
        課題カードをめくって<br>
        共通する解決策を揃えましょう！</center></h1>
        
        <div class="game-info">
            <div id="score">ペア: 0 / 6</div>
            <div id="attemptsLeft">残り失敗可能数: -</div>
            <div id="playerCount">挑戦者: 1人目</div>
            <div id="timer">⏱️ 0:00</div>
        </div>
        
        <div id="gameBoard"></div>
        
        <div class="button-container">
            <button onclick="resetGame()">🔄 リセット</button>
            <button onclick="showRankings()">🏆 ランキング</button>
        </div>
        
        <!-- 難易度選択モーダル -->
        <div id="difficultyModal" class="modal">
            <div class="modal-content">
                <!-- ここから追加・修正 -->
                <h2 style="color: #DC143C; margin-bottom: 15px; font-size: clamp(20px, 4vw, 30px);">遊び方</h2>
                <img src="howtoplay.png" alt="遊び方" style="max-width: 100%; height: auto; margin-bottom: 20px; border-radius: 10px;">
                <p style="font-size: clamp(14px, 2.5vw, 18px); color: #333; line-height: 1.5; margin-bottom: 20px;">
                    裏返しのカードを2枚めくり、<br>
                    表に表示された「解決策」が同じであればペア成立です。<br>
                    すべてのペアを見つけてクリアを目指しましょう！
                </p>
                <!-- ここまで追加・修正 -->
                
                <h2>難易度選択</h2>
                <p>NATIONSに参加したことはありますか？</p>
                <div class="difficulty-buttons">
                    <button onclick="setDifficulty(2, true, false)">はい (失敗可能数: 2回)</button>
                    <button onclick="setDifficulty(3, false, false)">いいえ (失敗可能数: 3回)</button>
                    <button class="interest-button" onclick="setDifficulty(4, false, true)">いいえ (興味があるので話を聞きたい) (失敗可能数: 4回)</button>
                </div>
            </div>
        </div>


        <!-- 勝利モーダル -->
        <div id="winModal" class="modal">
            <div class="modal-content">
                <h2>🎉 クリアおめでとうございます！ 🎉</h2>
                <p id="clearTime"></p>
                
                <div id="nameInputSection">
                    <p>ランキングに記録しますか？</p>
                    <input type="text" id="playerName" placeholder="お名前を入力" maxlength="20">
                    <button onclick="saveScore()">記録する</button>
                </div>
                
                <div id="rankingSaved" style="display: none;">
                    <p style="color: #48bb78; font-weight: bold;">✅ ランキングに記録されました！<br>
                        ECの"あるある課題"を共有できる仲間と<br>
                        一緒に解決していきませんか？</p>
                </div>
                
                <div class="ranking-section">
                    <h3>🏆 現在のランキング TOP5 🏆</h3>
                    <div id="rankingList"></div>
                </div>
                
                <button onclick="closeModal()">閉じる</button>
            </div>
        </div>
        
        <!-- ゲームオーバーモーダル -->
        <div id="gameOverModal" class="modal">
            <div class="modal-content">
                <h2 id="gameOverTitle">挑戦ありがとうございました！</h2>
                <p id="gameOverMessage"></p>
                <button onclick="resetGame()">リセット</button>
            </div>
        </div>

        <!-- ランキング専用モーダル -->
        <div id="rankingModal" class="modal">
            <div class="modal-content">
                <h2>🏆 ランキング 🏆</h2>
                <div id="rankingList2" class="ranking-list"></div>
                
                <!-- 管理者用ボタン群 -->
                <div class="admin-buttons" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                    <p style="color: #666; font-size: 14px; margin-bottom: 10px;">管理者用機能</p>
                    <button onclick="downloadRankingData()" style="background: #4CAF50; margin: 5px;">
                        📥 データダウンロード
                    </button>
                    <button onclick="showStatistics()" style="background: #2196F3; margin: 5px;">
                        📊 統計情報
                    </button>
                    <button onclick="resetRankings()" style="background: #666; margin: 5px;">
                        🗑️ データリセット
                    </button>
                </div>
                
                <button onclick="closeRankingModal()" style="margin-top: 10px;">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        // カードの内容を「あるある」と「解決策」のペアで定義
        const cardPairs = [
            { あるある: "深夜までの出荷作業", 解決策: "RSL、物流システム導入" },
            { あるある: "カオスな在庫管理", 解決策: "RSL、物流システム導入" },
            { あるある: "終わらない商品登録", 解決策: "CSV一括登録、AI活用" },
            { あるある: "SALEやイベント前の怒涛の準備", 解決策: "CSV一括登録、AI活用" },
            { あるある: "広告費ばかりかさんで費用対効果が見合わない", 解決策: "商品ページの見直し" },
            { あるある: "転換率（CVR）が伸びない", 解決策: "商品ページの見直し" },
            { あるある: "ブランドイメージが確立せず競合との差別化が難しい", 解決策: "コンテンツページの作成" },
            { あるある: "セールやイベント企画がマンネリ化し、売上が伸び悩む", 解決策: "コンテンツページの作成" },
            { あるある: "モチベーションが上がらずEC運営が楽しくない", 解決策: "楽天NATIONSへの参加" },
            { あるある: "楽天のルール変更やシステムアップデートに追いつけない", 解決策: "楽天NATIONSへの参加" },
            { あるある: "データ分析ができておらず、次の打ち手が分からない", 解決策: "楽天NATIONSへの参加" },
            { あるある: "ECに関するスキルをどうやって身に着けていくのか分からない", 解決策: "楽天NATIONSへの参加" }
        ];


        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        // const totalPairsInGame = 6; // 削除またはコメントアウト
        const totalSolutions = 6; // 解決策の種類数
        const totalCards = 12; // カードの総数


        let canFlip = true;
        let startTime = null;
        let timerInterval = null;
        let maxAttempts = 0;
        let attemptsLeft = 0;
        let playerCount = 1;
        let isNationsMember = false;
        let wantsToHearMore = false;

        // 難易度選択モーダルを表示
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('difficultyModal').style.display = 'flex';
            updatePlayerCount();
            document.getElementById('score').textContent = `ペア: 0 / ${totalPairsInGame}`; // 初期表示の更新
        });

        // 難易度設定
        function setDifficulty(numAttempts, isMember, wantsMore) {
            maxAttempts = numAttempts;
            attemptsLeft = numAttempts;
            isNationsMember = isMember;
            wantsToHearMore = wantsMore;
            document.getElementById('difficultyModal').style.display = 'none';
            initGame();
        }

        // ゲーム初期化
        function initGame() {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';
            
            // cardPairs をそのままシャッフルして、12枚のカードとして利用
            const allCardContents = [...cardPairs].sort(() => Math.random() - 0.5);
            
            // カードを作成
            allCardContents.forEach((data, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                // typeは不要になるが、残しておいても問題ない
                // card.dataset.type = 'あるある'; // すべてあるあるカードとみなす
                card.dataset.solutionId = data.解決策; // ペアチェック用のIDは「解決策」
        
                // 裏面表示用コンテンツ
                const cardBackContent = document.createElement('div');
                cardBackContent.className = 'card-back-content';
                cardBackContent.textContent = data.あるある; // 裏面は「あるある」
        
                // 表面表示用コンテンツ
                const cardFrontContent = document.createElement('div');
                cardFrontContent.className = 'card-front-content';
                cardFrontContent.textContent = data.解決策; // 表面は「解決策」
                
                card.appendChild(cardBackContent);
                card.appendChild(cardFrontContent);
                card.addEventListener('click', flipCard);
                gameBoard.appendChild(card);
                cards.push(card);
            });
        
            // 変数リセット
            matchedPairs = 0;
            canFlip = true;
            flippedCards = [];
            attemptsLeft = maxAttempts;
            
            // 表示を更新
            document.getElementById('score').textContent = `ペア: 0 / ${totalSolutions}`; // ここを「解決策の種類数」に
            document.getElementById('attemptsLeft').textContent = `残り失敗可能数: ${attemptsLeft}`;
            // タイマー開始
            startTime = Date.now();
            updateTimer();
            timerInterval = setInterval(updateTimer, 100);
        }


        // タイマー更新
        function updateTimer() {
            if (!startTime) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timer').textContent = `⏱️ ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // カードをめくる
        function flipCard(e) {
            const card = e.target.closest('.card');
            
            if (!card || !canFlip || card.classList.contains('flipped') || card.classList.contains('matched')) {
                return;
            }
            
            card.classList.add('flipped');
            flippedCards.push(card);
            
            if (flippedCards.length === 2) {
                canFlip = false;
                checkMatch();
            }
        }

        // ペアチェック
        function checkMatch() {
            const [card1, card2] = flippedCards;
            
            // solutionIdが一致すればペア成立
            if (card1.dataset.solutionId === card2.dataset.solutionId) { // ここを変更
                // ペア成立
                setTimeout(() => {
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    matchedPairs++;
                    document.getElementById('score').textContent = `ペア: ${matchedPairs} / ${totalSolutions}`; // totalSolutions を使用
                    
                    if (matchedPairs === totalSolutions) { // 全ペアが揃ったらクリア
                        clearInterval(timerInterval);
                        showWinModal();
                    }
                    
                    flippedCards = [];
                    canFlip = true;
                }, 300);
            } else {
                // ペア不成立
                attemptsLeft--;
                document.getElementById('attemptsLeft').textContent = `残り失敗可能数: ${attemptsLeft}`;
                setTimeout(() => {
                    card1.classList.remove('flipped');
                    card2.classList.remove('flipped');
                    flippedCards = [];
                    
                    if (attemptsLeft <= 0) {
                        clearInterval(timerInterval);
                        showGameOverModal();
                    } else {
                        canFlip = true;
                    }
                }, 1000);
            }
        }
    

        // 勝利モーダル表示
        function showWinModal() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            window.currentClearTime = elapsed;
            
            document.getElementById('clearTime').textContent = 
                `クリアタイム: ${minutes}分${seconds}秒\n失敗回数: ${maxAttempts - attemptsLeft}回`;
            
            updateRankingDisplay();
            
            document.getElementById('winModal').style.display = 'flex';
        }

        // ゲームオーバーモーダル表示
        function showGameOverModal() {
            const gameOverMessageElement = document.getElementById('gameOverMessage');
            if (isNationsMember) {
                gameOverMessageElement.textContent = "今後ともNATIONSをよろしくお願いいたします！";
            } else if (wantsToHearMore) {
                gameOverMessageElement.textContent = "ECあるあるを言い合いながら売上を伸ばす仲間を作りませんか？ (詳細をご案内します)";
            }
            else {
                gameOverMessageElement.textContent = "ECあるあるを言い合いながら売上を伸ばしませんか？";
            }
            document.getElementById('gameOverModal').style.display = 'flex';
        }

        // モーダルを閉じる (勝利モーダル用)
        function closeModal() {
            document.getElementById('winModal').style.display = 'none';
            document.getElementById('nameInputSection').style.display = 'block';
            document.getElementById('rankingSaved').style.display = 'none';
            document.getElementById('playerName').value = '';
            
            resetGame();
        }

        // ゲームリセット (リセットボタン、ゲームオーバー後)
        function resetGame() {
            clearInterval(timerInterval);
            cards = [];
            
            document.getElementById('gameOverModal').style.display = 'none';

            updatePlayerCount();
            
            document.getElementById('difficultyModal').style.display = 'flex';
        }

        // 挑戦者数を更新する関数
        function updatePlayerCount() {
            const rankings = getRankings();
            playerCount = rankings.length + 1; 
            document.getElementById('playerCount').textContent = `挑戦者: ${playerCount}人目`;
        }

        // Service Worker登録
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }

        // ランキングデータを管理する関数
        function getRankings() {
            const rankings = localStorage.getItem('ecGameRankings');
            return rankings ? JSON.parse(rankings) : [];
        }
        
        function saveRanking(time, name) {
            const rankings = getRankings();
            rankings.push({ 
                name, 
                time, 
                date: new Date().toLocaleDateString(), 
                missCount: maxAttempts - attemptsLeft,
                isNationsMember: isNationsMember,
                wantsToHearMore: wantsToHearMore
            }); 
            rankings.sort((a, b) => a.time - b.time);
            localStorage.setItem('ecGameRankings', JSON.stringify(rankings));
        }
        
        // ランキング表示を更新する関数 (勝利モーダル内)
        function updateRankingDisplay() {
            const rankings = getRankings();
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';
            
            if (rankings.length === 0) {
                rankingList.innerHTML = '<p style="color: #666;">まだ記録がありません</p>';
                return;
            }
            
            const displayCount = Math.min(rankings.length, 5);
            for (let i = 0; i < displayCount; i++) {
                const record = rankings[i];
                const minutes = Math.floor(record.time / 60);
                const seconds = record.time % 60;
                const item = document.createElement('div');
                item.className = 'ranking-item';
                item.innerHTML = `
                    <span class="rank">${i + 1}位</span>
                    <span class="name">${record.name}</span>
                    <span class="time">${minutes}分${seconds}秒 (失敗: ${record.missCount || 0})</span>
                `;
                rankingList.appendChild(item);
            }
        }
        
        // 名前を入力して記録を保存
        function saveScore() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim() || '名無しさん';
            
            saveRanking(window.currentClearTime, name);
            updateRankingDisplay();
            
            document.getElementById('nameInputSection').style.display = 'none';
            document.getElementById('rankingSaved').style.display = 'block';
        }
        
        // ランキングを表示する関数 (ランキングボタン用)
        function showRankings() {
            const rankings = getRankings();
            const rankingList = document.getElementById('rankingList2');
            rankingList.innerHTML = '';
            
            if (rankings.length === 0) {
                rankingList.innerHTML = '<p style="color: #666;">まだ記録がありません</p>';
            } else {
                const displayCount = Math.min(rankings.length, 10);
                
                for (let i = 0; i < displayCount; i++) {
                    const record = rankings[i];
                    const minutes = Math.floor(record.time / 60);
                    const seconds = record.time % 60;
                    const item = document.createElement('div');
                    item.className = 'ranking-item';
                    item.innerHTML = `
                        <span class="rank">${i + 1}位</span>
                        <span class="name">${record.name}</span>
                        <span class="time">${minutes}分${seconds}秒 (失敗: ${record.missCount || 0})</span>
                    `;
                    rankingList.appendChild(item);
                }
                
                if (rankings.length > 10) {
                    rankingList.innerHTML += `<p style="color: #666; margin-top: 10px;">他${rankings.length - 10}件の記録があります</p>`;
                }
            }
            
            document.getElementById('rankingModal').style.display = 'flex';
        }
        
        // ランキングモーダルを閉じる
        function closeRankingModal() {
            document.getElementById('rankingModal').style.display = 'none';
        }
        
        // CSVダウンロード機能を追加
        function downloadRankingData() {
            const rankings = getRankings();
            
            if (rankings.length === 0) {
                alert('ダウンロードするデータがありません');
                return;
            }
            
            let csv = '順位,名前,タイム（秒）,タイム（表示）,失敗回数,NATIONS参加者,話を聞きたい,日付\n';
            
            rankings.forEach((record, index) => {
                const minutes = Math.floor(record.time / 60);
                const seconds = record.time % 60;
                const timeDisplay = `${minutes}分${seconds}秒`;
                const nationsMemberStatus = record.isNationsMember ? 'はい' : 'いいえ';
                const wantsToHearMoreStatus = record.wantsToHearMore ? 'はい' : 'いいえ';
                csv += `${index + 1},${record.name},${record.time},${timeDisplay},${record.missCount || 0},${nationsMemberStatus},${wantsToHearMoreStatus},${record.date}\n`;
            });
            
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ECゲームランキング_${new Date().toLocaleDateString()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 統計情報を表示する関数
        function showStatistics() {
            const rankings = getRankings();
            
            if (rankings.length === 0) {
                alert('データがありません');
                return;
            }
            
            const totalPlayers = rankings.length;
            const times = rankings.map(r => r.time);
            const missCounts = rankings.map(r => r.missCount || 0);
            const nationsMembers = rankings.filter(r => r.isNationsMember).length;
            const wantsToHearMoreCount = rankings.filter(r => r.wantsToHearMore).length;

            const avgTime = Math.floor(times.reduce((a, b) => a + b, 0) / totalPlayers);
            const bestTime = Math.min(...times);
            const worstTime = Math.max(...times);
            
            const avgMissCount = (missCounts.reduce((a, b) => a + b, 0) / totalPlayers).toFixed(1);
            const minMissCount = Math.min(...missCounts);
            const maxMissCount = Math.max(...missCounts);

            const avgMinutes = Math.floor(avgTime / 60);
            const avgSeconds = avgTime % 60;
            
            alert(`📊 統計情報\n\n` +
                  `参加者数: ${totalPlayers}人\n` +
                  `NATIONS参加者: ${nationsMembers}人\n` + 
                  `話を聞きたい人数: ${wantsToHearMoreCount}人\n` +
                  `平均クリアタイム: ${avgMinutes}分${avgSeconds}秒\n` +
                  `最速クリア: ${Math.floor(bestTime / 60)}分${bestTime % 60}秒\n` +
                  `最遅クリア: ${Math.floor(worstTime / 60)}分${worstTime % 60}秒\n\n` +
                  `平均失敗回数: ${avgMissCount}回\n` +
                  `最小失敗回数: ${minMissCount}回\n` +
                  `最大失敗回数: ${maxMissCount}回`);
        }

        // ランキングをリセットする関数
        function resetRankings() {
            if (confirm('ランキングをすべて削除しますか？')) {
                localStorage.removeItem('ecGameRankings');
                alert('ランキングをリセットしました');
                updateRankingDisplay();
                showRankings();
                updatePlayerCount();
            }
        }
    </script>
</body>
</html>
